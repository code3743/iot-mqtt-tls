name: Build and OTA Publish

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      firmware-name: ${{ steps.buildinfo.outputs.firmware-name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install PlatformIO
        run: |
          pip install platformio
          platformio platform install espressif32

      - name: Detect firmware version
        id: buildinfo
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            exit 0
          fi
          echo "FIRMWARE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "firmware-name=firmware_${VERSION}.bin" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Firmware version set to $VERSION"

      - name: Build firmware
        run: |
          echo "MQTT_SERVER=${{ secrets.MQTT_SERVER }}" >> .env
          echo "MQTT_PORT=${{ secrets.MQTT_PORT }}" >> .env
          echo "MQTT_USER=${{ secrets.MQTT_USER }}" >> .env
          echo "MQTT_PASSWORD=${{ secrets.MQTT_PASSWORD }}" >> .env
          echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
          echo "STATE=${{ secrets.STATE }}" >> .env
          echo "CITY=${{ secrets.CITY }}" >> .env
          echo "WIFI_SSID=\"${{ secrets.WIFI_SSID }}\"" >> .env
          echo "WIFI_PASSWORD=\"${{ secrets.WIFI_PASSWORD }}\"" >> .env
          echo "ROOT_CA=\"${{ secrets.ROOT_CA }}\"" >> .env
          python3 scripts/add_env_defines.py

      - name: Upload firmware to S3
        run: |
          aws s3 cp .pio/build/esp32s3/firmware.bin s3://${{ secrets.S3_BUCKET_NAME }}/${{ steps.buildinfo.outputs.firmware-name }} \
            --content-type application/octet-stream
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

  publish_ota:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Publish OTA MQTT message
        run: |
          pip install paho-mqtt
          python3 -c "import os, json, paho.mqtt.publish as publish; \
          bucket='${{ secrets.S3_BUCKET_NAME }}'; \
          region='${{ secrets.AWS_REGION }}'; \
          firmware='${{ needs.build.outputs.firmware-name }}'; \
          version=os.getenv('FIRMWARE_VERSION', firmware.replace('firmware_', '').replace('.bin','')); \
          url=f'https://{bucket}.s3.{region}.amazonaws.com/{firmware}'; \
          payload=json.dumps({'version': version, 'url': url}); \
          publish.single( \
            topic=os.getenv('DEVICE_TOPIC', 'dispositivo/device1/ota'), \
            payload=payload, \
            hostname=os.getenv('MQTT_SERVER'), \
            port=int(os.getenv('MQTT_PORT')), \
            auth={'username': os.getenv('MQTT_USER'), 'password': os.getenv('MQTT_PASSWORD')} if os.getenv('MQTT_USER') else None, \
            tls={} if os.getenv('MQTT_TLS', 'false') == 'true' else None \
          ); \
          print('âœ… Mensaje OTA enviado:', payload)"
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          MQTT_SERVER: ${{ secrets.MQTT_SERVER }}
          MQTT_PORT: ${{ secrets.MQTT_PORT }}
          MQTT_USER: ${{ secrets.MQTT_USER }}
          MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
          MQTT_TLS: ${{ secrets.MQTT_TLS }}
