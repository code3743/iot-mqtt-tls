name: OTA Update to ESP32 via MQTT TLS

on:
  workflow_run:
    workflows: ["Build IoT MQTT TLS"]
    types: [completed]

  push:
    tags:
      - 'v*.*.*'

jobs:
  ota-publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: firmware-bin
          path: ./firmware

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install AWS CLI and dependencies
        run: |
          sudo rm -rf /usr/local/aws-cli/v2
          pip install awscli paho-mqtt

      # âœ… Detectar versiÃ³n desde tag o generar una versiÃ³n dev
      - name: Set firmware version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "FIRMWARE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            DATE=$(date -u +"%Y-%m-%d_%H-%M")
            echo "FIRMWARE_VERSION=dev-${DATE}" >> $GITHUB_ENV
          fi
          echo "FIRMWARE_NAME=firmware_${FIRMWARE_VERSION}.bin" >> $GITHUB_ENV

      - name: Upload firmware to S3
        run: |
          aws s3 cp ./firmware/firmware.bin "s3://${S3_BUCKET_NAME}/${FIRMWARE_NAME}" \
            --content-type application/octet-stream
          echo "âœ… Firmware uploaded to S3: s3://${S3_BUCKET_NAME}/${FIRMWARE_NAME}"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

      - name: Publish MQTT OTA message
        run: |
          python3 -c "import os, json, paho.mqtt.publish as publish; \
          url = 'https://{bucket}.s3.{region}.amazonaws.com/{firmware}'.format( \
            bucket=os.getenv('S3_BUCKET_NAME'), \
            region=os.getenv('AWS_REGION'), \
            firmware=os.getenv('FIRMWARE_NAME') \
          ); \
          payload = json.dumps({ 'version': os.getenv('FIRMWARE_VERSION'), 'url': url }); \
          print('ðŸ“¦ OTA Payload:', payload); \
          publish.single( \
            topic=os.getenv('DEVICE_TOPIC'), \
            payload=payload, \
            hostname=os.getenv('MQTT_SERVER'), \
            port=int(os.getenv('MQTT_PORT')), \
            auth={ 'username': os.getenv('MQTT_USER'), 'password': os.getenv('MQTT_P
